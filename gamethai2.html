<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>สื่อการสอนโรงเรียนบ้านวังด้ง</title>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/jspdf-thai-font@1.0.6/dist/th-sarabun-new-normal.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="icon" href="https://raw.githubusercontent.com/infobwd/wdconnect/main/%E0%B8%AA%E0%B8%9E%E0%B8%90%203D%20%E0%B8%82%E0%B8%AD%E0%B8%9A.png" type="image/png">
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-thai@1.0.4/dist/jspdf.umd.thai.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-thai-font@1.0.6/dist/th-sarabun-new-normal.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdfmake-thai-font@1.0.3/dist/pdfmake-thai-font.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <style>
        body {
            font-family: 'Google Sans', sans-serif;
            padding-top: 80px;
            padding-bottom: 50px;
        }
        .navbar {
            background-color: #0066cc !important;
        }
        .navbar-brand, .navbar-button {
            color: white !important;
        }
        .navbar-button:hover {
            color: #f8f9fa !important;
        }
        .navbar-brand img {
            height: 30px;
            margin-right: 10px;
        }
        #setup, #game {
            max-width: 600px;
            margin: 0 auto;
            margin-top: 10px;
        }
        #game {
            display: none;
        }
        .team-setup {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .team-input {
            width: 45%;
        }
        .team-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .team-display {
            display: flex;
            align-items: center;
            padding: 5px;
            border-radius: 5px;
            position: relative;
        }
        .active-team {
            background-color: #ffffd0; /* Light pastel yellow */
        }
        .crown-icon {
            position: absolute;
            top: -10px;
            left: 12%;
            transform: translateX(-50%) rotate(-10deg);
            font-size: 24px;
            color: #ffd700; /* Dark yellow */
            display: none;
        }
        .leading-team .crown-icon {
            display: block;
        }
        .team-icon {
            font-size: 32px;
            margin-right: 10px;
        }
        .score-buttons {
            display: flex;
            align-items: center;
        }
        .score-button {
            width: 30px;
            height: 30px;
            font-size: 20px;
            padding: 0;
            margin: 0 2px;
        }
        .score-button.add { background-color: #34a853; }
        .score-button.subtract { background-color: #ea4335; }
        #puzzle {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-gap: 5px;
            margin-bottom: 20px;
        }
        .piece {
            aspect-ratio: 1 / 1;
            border: 2px solid #ccc;
            font-size: 54px;
            background-size: 300% 300%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            position: relative;
        }
        .piece::before {
            content: '';
            position: absolute;
            width: 30px;
            height: 30px;
            background-color: var(--piece-bg-color);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: -1;
        }
        .piece[data-index="0"]::before { background-color: #FFB3BA; }
        .piece[data-index="1"]::before { background-color: #FFDFBA; }
        .piece[data-index="2"]::before { background-color: #FFFFBA; }
        .piece[data-index="3"]::before { background-color: #BAFFC9; }
        .piece[data-index="4"]::before { background-color: #BAE1FF; }
        .piece[data-index="5"]::before { background-color: #FFB3FF; }
        .piece[data-index="6"]::before { background-color: #B3E5FF; }
        .piece[data-index="7"]::before { background-color: #D4BAFF; }
        .piece[data-index="8"]::before { background-color: #FFCBA4; }
        .revealed {
            background-color: transparent;
        }
        #solution-modal, #countdown-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 15vw;
            text-align: center;
            z-index: 1000;
        }
        #solution-modal .red {
            color: red;
        }
        @media (max-width: 600px) {
            .piece { font-size: 54px; }
            .title-spacing {
                margin-top: 25px;
                margin-bottom: 2px;
            }
            .team-info {
                flex-direction: row;
                align-items: center;
                justify-content: space-between;
            }
            .team-display {
                flex-direction: row;
                align-items: center;
                width: 45%;
            }
            .team-icon {
                font-size: 34px;
            }
            #word-set-title {
                display: block;
                text-align: center;
                margin-top: 2px;
                margin-bottom: 2px;
            }

            #word-set-title br {
                display: block;
            }
        }
        footer {
            background-color: rgba(255, 255, 255, 0.7);
            padding: 5px 10px;
            position: fixed;
            bottom: 0;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.875rem;
        }
        .support-button, .contact-button {
            background-color: #0066cc;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 0.875rem;
        }
        .support-button:hover, .contact-button:hover {
            background-color: #004d99;
        }
        .support-button i, .contact-button i {
            margin-right: 5px;
        }
        .button-group {
            display: flex;
            gap: 5px;
            justify-content: flex-end;
        }
   
        .navbar .navbar-button {
            margin-left: 5px;
        }
        #showNavbarTab {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            background-color: #0066cc;
            color: white;
            padding: 10px;
            cursor: pointer;
            z-index: 1001;
        }
        #showNavbarTab i {
            font-size: 24px;
        }
        #promptpay-number {
            cursor: pointer;
            text-decoration: underline;
            color: blue;
        }
        #qr-code-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            align-items: center; /* Center the modal vertically */
            justify-content: center; /* Center the modal horizontally */
        }
        #qr-code-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%; /* Full width on mobile */
            max-width: 300px; /* Max width */
            text-align: center;
        }
        #qr-code-img {
            width: 200px;
            height: 200px;
        }
        .btn-qr-option {
            width: 100%;
            margin-bottom: 10px;
        }
      #copy-promptpay {
          margin-left: 10px;
          padding: 2px 8px;
          font-size: 0.8em;
      }

      #copy-feedback {
          font-size: 0.9em;
          margin-top: 5px;
      }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="https://wd-information.glitch.me/gamethai2.html">
                <img src="https://raw.githubusercontent.com/infobwd/wdconnect/main/%E0%B8%AA%E0%B8%9E%E0%B8%90%203D%20%E0%B8%82%E0%B8%AD%E0%B8%9A.png" alt="Logo">
                สื่อการสอนโรงเรียนบ้านวังด้ง
            </a>
              <div class="d-flex align-items-center">
                <button class="btn btn-outline-light navbar-button" id="toggleNavbar" data-bs-toggle="tooltip" title="Toggle Navbar">
                    <i class="bi bi-eye"></i>
                </button>
                <button class="btn btn-outline-light navbar-button" id="fullscreenButton" data-bs-toggle="tooltip" title="Fullscreen">
                    <i class="bi bi-fullscreen"></i>
                </button>
                <button class="btn btn-outline-light navbar-button" id="shareFacebook" data-bs-toggle="tooltip" title="Share on Facebook">
                    <i class="bi bi-facebook"></i>
                </button>
                <button class="btn btn-outline-light navbar-button" id="shareLine" data-bs-toggle="tooltip" title="Share on Line">
                    <i class="bi bi-line"></i>
                </button>
               <button id="liffLoginButton" class="btn btn-outline-light navbar-button me-2" style="display: none;">
                    <i class="bi bi-line"></i> Line Login
               </button>
               <button id="liffLogoutButton" class="btn btn-outline-light navbar-button me-2" style="display: none;">
                  <i class="bi bi-box-arrow-right"></i> Logout
               </button>
              <img id="lineProfileImage" src="" alt="Line Profile" style="width: 30px; height: 30px; border-radius: 50%; display: none;">
            </div>
        </div>
    </nav>
    <div id="showNavbarTab" onclick="showNavbar()">
        <i class="bi bi-list"></i>
    </div>

    <div class="container">
        <h1 class="text-center title-spacing">เปิดป้ายทายคำ</h1>
        <div id="setup">
            <div class="team-setup">
                <div class="team-input">
                    <input type="text" id="team1-name-input" class="form-control" placeholder="ชื่อทีม 1">
                  <select id="team1-icon-select" class="form-select mt-2">
                      <option value="" selected disabled>เลือกสัตว์</option>
                      <option value="🐶">🐶 น้องหมา</option>
                      <option value="🐱">🐱 น้องแมว</option>
                      <option value="🐭">🐭 น้องหนู</option>
                      <option value="🐰">🐰 น้องกระต่าย</option>
                      <option value="🐼">🐼 น้องแพนด้า</option>
                      <option value="🦊">🦊 น้องจิ้งจอก</option>
                      <option value="🦁">🦁 น้องสิงโต</option>
                      <option value="🐸">🐸 น้องกบ</option>
                      <option value="🐧">🐧 น้องเพนกวิน</option>
                      <option value="🦉">🦉 น้องนกฮูก</option>
                  </select>
                </div>
                <div class="team-input">
                    <input type="text" id="team2-name-input" class="form-control" placeholder="ชื่อทีม 2">
                    <select id="team2-icon-select" class="form-select mt-2">
                      <option value="" selected disabled>เลือกสัตว์</option>
                      <option value="🐱">🐱 น้องแมว</option>
                      <option value="🐶">🐶 น้องหมา</option>
                      <option value="🐭">🐭 น้องหนู</option>
                      <option value="🐰">🐰 น้องกระต่าย</option>
                      <option value="🐼">🐼 น้องแพนด้า</option>
                      <option value="🦊">🦊 น้องจิ้งจอก</option>
                      <option value="🦁">🦁 น้องสิงโต</option>
                      <option value="🐸">🐸 น้องกบ</option>
                      <option value="🐧">🐧 น้องเพนกวิน</option>
                      <option value="🦉">🦉 น้องนกฮูก</option>
                    </select>
                </div>
            </div>
            <select id="countdown-select" class="form-select mb-3">
                <option value="10">10 วินาที</option>
                <option value="20">20 วินาที</option>
                <option value="30">30 วินาที</option>
                <option value="40">40 วินาที</option>
                <option value="50">50 วินาที</option>
                <option value="60">60 วินาที</option>
            </select>
            <select id="word-set-select" class="form-select mb-3" required>
                <option value="">เลือกชุดคำ</option>
            </select>
            <button id="start-game" class="btn btn-primary w-100" data-bs-toggle="tooltip" title="Start Game">เริ่มเกม</button>
        </div>
        <div id="game">
            <div id="word-set-title" class="text-center mb-3"></div>
            <div class="team-info">
                <div class="team-display" id="team1-display">
                    <div class="crown-icon">👑</div>
                    <div class="team-icon" id="team1-icon"></div>
                    <div class="team-name" id="team1-name"></div>
                    <div class="score-buttons">
                        <button class="btn btn-danger score-button subtract" onclick="updateScore(1, -1)">-</button>
                        <span class="mx-2" id="team1-score">0</span>
                        <button class="btn btn-success score-button add" onclick="updateScore(1, 1)">+</button>
                    </div>
                </div>
                <div class="team-display" id="team2-display">
                    <div class="crown-icon">👑</div>
                    <div class="team-icon" id="team2-icon"></div>
                    <div class="team-name" id="team2-name"></div>
                    <div class="score-buttons">
                        <button class="btn btn-danger score-button subtract" onclick="updateScore(2, -1)">-</button>
                        <span class="mx-2" id="team2-score">0</span>
                        <button class="btn btn-success score-button add" onclick="updateScore(2, 1)">+</button>
                    </div>
                </div>
            </div>
            <div id="puzzle"></div>
            <audio id="countdown-audio" src="https://raw.githubusercontent.com/infobwd/wdconnect/main/clock-ticking-60-second-countdown-118231.mp3"></audio>
            <div class="button-group mt-3">
                <button id="reveal-button" class="btn btn-warning" data-bs-toggle="tooltip" title="Reveal Answer"><i class="bi bi-eye-fill"></i> เฉลย</button>
                <button id="hint-button" class="btn btn-info" data-bs-toggle="tooltip" title="Use Hint"><i class="bi bi-lightbulb-fill"></i> คำใบ้</button>
                <button id="next-word-button" class="btn btn-primary" data-bs-toggle="tooltip" title="Next Word"><i class="bi bi-arrow-right"></i> คำถัดไป</button>
                              <button id="generate-pdf-button" class="btn btn-secondary" onclick="generateHandwritingPDF()"><i class="bi bi-file-earmark-pdf"></i> สร้างแบบฝึก
                </button>
                <button id="restart-game-button" class="btn btn-secondary" data-bs-toggle="tooltip" title="Restart Game"><i class="bi bi-arrow-repeat"></i> เริ่มเกมใหม่</button>

            </div>
        </div>
        <div id="solution-modal">
            <p id="solution-text"></p>
        </div>
        <div id="countdown-modal">
            <div class="team-info">
                <div class="team-display">
                    <div class="team-icon" id="countdown-team-icon"></div>
                    <div class="team-name" id="countdown-team-name"></div>
                </div>
            </div>
            <p id="countdown-text"></p>
        </div>
    </div>

    <div id="qr-code-modal">
        <div id="qr-code-content">
            <h2>เลี้ยงกาแฟนพรุจ</h2>
            <img id="qr-code-img" src="" alt="QR Code">
            <p>Scan QRcode หรือคัดลอกเบอร์พร้อมเพย์: 
                <span id="promptpay-number-display">0836645989</span>
                <button id="copy-promptpay" class="btn btn-secondary btn-sm ml-2">
                    <i class="bi bi-clipboard"></i> Copy
                </button>
            </p>
            <div id="copy-feedback" class="text-success" style="display: none;">คัดลอกแล้ว!</div>
            <button class="btn btn-danger mt-3" onclick="closeQRCodeModal()">ปิด</button>
        </div>
    </div>

    <footer>
        <span>&copy; 2024 โรงเรียนบ้านวังด้ง</span>
        <div>
            <button class="support-button" onclick="showSupportMessage()">
                <i class="bi bi-cup"></i> สนับสนุนเรา
            </button>
            <button class="contact-button" id="contactButton">
                <i class="bi bi-envelope"></i> ติดต่อเรา
            </button>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const setupDiv = document.getElementById('setup');
        const gameDiv = document.getElementById('game');
        const puzzleDiv = document.getElementById('puzzle');
        const revealButton = document.getElementById('reveal-button');
        const nextWordButton = document.getElementById('next-word-button');
        const restartGameButton = document.getElementById('restart-game-button');
        const solutionModal = document.getElementById('solution-modal');
        const solutionText = document.getElementById('solution-text');
        const startGameButton = document.getElementById('start-game');
        const wordSetSelect = document.getElementById('word-set-select');
        const wordSetTitle = document.getElementById('word-set-title');
        const countdownModal = document.getElementById('countdown-modal');
        const countdownText = document.getElementById('countdown-text');
        const hintButton = document.getElementById('hint-button');
        const shareButton = document.getElementById('shareFacebook');
        const lineButton = document.getElementById('shareLine');
        const toggleNavbarButton = document.getElementById('toggleNavbar');
        const showNavbarTab = document.getElementById('showNavbarTab');

        let timeLeft;
        let countdownInterval;
        let currentWord;
        let currentImage;
        let currentRedLetter;
        let wordSets = [];
        let currentWordSet = [];
        let currentWordIndex = 0;
        let teamScores = [0, 0];
        let hintUsed = false;
        let currentOpeningTeam = 1;

        const teamIcons = {
            '🐶': 'ทีมน้องหมา',
            '🐱': 'ทีมน้องแมว',
            '🐭': 'ทีมน้องหนู',
            '🐰': 'ทีมน้องกระต่าย',
            '🐼': 'ทีมน้องแพนด้า',
            '🦊': 'ทีมน้องจิ้งจอก',
            '🦁': 'ทีมน้องสิงโต',
            '🐸': 'ทีมน้องกบ',
            '🐧': 'ทีมน้องเพนกวิน',
            '🦉': 'ทีมน้องนกฮูก'
        };
        let usedNames = [];

        function getRandomTeamIcon() {
            const icons = Object.keys(teamIcons);
            return icons[Math.floor(Math.random() * icons.length)];
        }
        
        function getTeamNameFromIcon(icon) {
            return teamIcons[icon] || 'ทีมไม่ระบุชื่อ';
        }
        
        function getRandomThaiName() {
            const icon = getRandomTeamIcon();
            return getTeamNameFromIcon(icon);
        }

        function displayError(message) {
            Swal.fire({
                icon: 'error',
                title: 'เกิดข้อผิดพลาด',
                text: message,
                confirmButtonText: 'ตกลง'
            });
        }

        async function fetchWordSets() {
            try {
                const response = await fetch('https://opensheet.elk.sh/1YVZV9IN3K1bIXO0am28DHXONnQWFVs-gguHyYgsuXHQ/ชุดคำ');
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                wordSets = await response.json();
                if (!Array.isArray(wordSets) || wordSets.length === 0) {
                    throw new Error('Invalid data received for word sets');
                }
                wordSets.forEach(set => {
                    if (set && set['ID ชุดคำ'] && set['ชื่อชุดคำ']) {
                        const option = document.createElement('option');
                        option.value = set['ID ชุดคำ'];
                        option.textContent = set['ชื่อชุดคำ'];
                        wordSetSelect.appendChild(option);
                    }
                });
                if (wordSetSelect.options.length <= 1) {
                    throw new Error('ไม่สามารถโหลดชุดคำได้ กรุณารีเฟรชหน้าเว็บและลองใหม่อีกครั้ง');
                }
            } catch (error) {
                console.error('Error fetching word sets:', error);
                displayError(error.message);
            }
        }

  async function fetchWords(wordSetId) {
    try {
        const response = await fetch(`https://opensheet.elk.sh/1YVZV9IN3K1bIXO0am28DHXONnQWFVs-gguHyYgsuXHQ/คำ`);
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        const data = await response.json();
        if (!Array.isArray(data)) {
            throw new Error('Invalid data received for words');
        }
        return data.filter(word => word && word['ID ชุดคำ'] === wordSetId);
    } catch (error) {
        console.error('Error fetching words:', error);
        return [];
    }
}

        function startCountdown() {
            clearInterval(countdownInterval);
            const countdownSelect = document.getElementById('countdown-select');
            if (countdownSelect) {
                timeLeft = parseInt(countdownSelect.value) || 30;
            } else {
                timeLeft = 30;
            }
            updateCountdownDisplay();
            countdownModal.style.display = 'flex';
            
            // Play countdown audio
            const countdownAudio = document.getElementById('countdown-audio');
            if (countdownAudio) {
                countdownAudio.play();
            }

            countdownInterval = setInterval(() => {
                if (timeLeft > 0) {
                    timeLeft--;
                    updateCountdownDisplay();
                } else {
                    clearInterval(countdownInterval);
                    countdownModal.style.display = 'none';
                    if (countdownAudio) {
                        countdownAudio.pause();
                        countdownAudio.currentTime = 0;
                    }
                    countdownText.innerHTML = `${timeLeft} หมดเวลา`;
                    switchTeam();
                }
            }, 1000);
        }

        function updateCountdownDisplay() {
            if (countdownText) {
                const pastelColors = ['#FFB3BA', '#FFDFBA', '#FFFFBA', '#BAFFC9', '#BAE1FF', '#FFB3FF', '#B3E5FF', '#D4BAFF', '#FFCBA4'];
                const randomColor = pastelColors[Math.floor(Math.random() * pastelColors.length)];
                countdownText.style.color = randomColor;
                countdownText.textContent = `${timeLeft}`;
            }
        }


function revealSolution() {
    if (solutionText && currentWord) {
        let coloredWord = '';
        if (currentRedLetter) {
            // กรณีมีตัวอักษรที่ต้องการให้สีต่างจากพวก
            coloredWord = currentWord.replace(currentRedLetter, `<span style="color: red;">${currentRedLetter}</span>`);
        } else {
            // กรณีไม่มีตัวอักษรที่ต้องการให้สีต่างจากพวก
            const thaiConsonants = 'กขฃคฅฆงจฉชซฌญฎฏฐฑฒณดตถทธนบปผฝพฟภมยรลวศษสหฬอฮ';
            const thaiVowels = 'ะัาำิีึืุูเแโใไ็์';
            const thaiToneMarks = '่้๊๋';

            coloredWord = currentWord.split('').map(char => {
                if (thaiConsonants.includes(char)) {
                    return `<span style="color: white;">${char}</span>`;
                } else if (thaiVowels.includes(char)) {
                    return `<span style="color: red;">${char}</span>`;
                } else if (thaiToneMarks.includes(char)) {
                    return `<span style="color: green;">${char}</span>`;
                } else {
                    return `<span style="color: blue;">${char}</span>`; // ตัวสะกดหรืออักขระอื่นๆ
                }
            }).join('');
        }
        
        solutionText.innerHTML = coloredWord;
        if (solutionModal) solutionModal.style.display = 'flex';
        if (nextWordButton) nextWordButton.style.display = 'inline-block';
        if (revealButton) revealButton.style.display = 'none';
        
        document.querySelectorAll('.piece').forEach(piece => {
            piece.style.backgroundImage = `url(${currentImage})`;
            piece.style.backgroundPosition = `${-100 * (piece.dataset.index % 3)}% ${-100 * Math.floor(piece.dataset.index / 3)}%`;
            piece.classList.add('revealed');
        });
    }
}

        function resetPuzzle() {
            if (puzzleDiv) puzzleDiv.innerHTML = '';
            if (revealButton) revealButton.style.display = 'inline-block';
            if (nextWordButton) nextWordButton.style.display = 'none';
            clearInterval(countdownInterval);
            if (countdownModal) countdownModal.style.display = 'none';
        }

        function getGameResult() {
            const team1Score = teamScores[0];
            const team2Score = teamScores[1];
            const team1Name = document.getElementById('team1-name').textContent;
            const team2Name = document.getElementById('team2-name').textContent;

            let resultText = `ผลการแข่งขัน:\n${team1Name}: ${team1Score} คะแนน\n${team2Name}: ${team2Score} คะแนน\n\n`;

            if (team1Score > team2Score) {
                resultText += `ทีมชนะ: ${team1Name}`;
            } else if (team2Score > team1Score) {
                resultText += `ทีมชนะ: ${team2Name}`;
            } else {
                resultText += "ผลการแข่งขัน: เสมอ";
            }

            return resultText;
        }

        function highlightActiveTeam() {
            const team1Display = document.getElementById('team1-display');
            const team2Display = document.getElementById('team2-display');

            team1Display.classList.toggle('active-team', currentOpeningTeam === 1);
            team2Display.classList.toggle('active-team', currentOpeningTeam === 2);

            const team1Score = parseInt(document.getElementById('team1-score').textContent);
            const team2Score = parseInt(document.getElementById('team2-score').textContent);

            team1Display.classList.toggle('leading-team', team1Score > team2Score);
            team2Display.classList.toggle('leading-team', team2Score > team1Score);
        }

        function createPuzzle() {
            resetPuzzle();
            
            if (currentWordIndex >= currentWordSet.length) {
                endGame();
                return;
            }

            const word = currentWordSet[currentWordIndex];
            currentWord = word['คำ'];
            currentImage = word['ลิงก์รูปภาพ'];
            currentRedLetter = word['ตัวอักษรที่ต้องการให้สีต่างจากพวก'];

            for (let i = 0; i < 9; i++) {
                const piece = document.createElement('div');
                piece.className = 'piece';
                piece.dataset.index = i;
                piece.textContent = i + 1;
                piece.addEventListener('click', () => {
                    if (!piece.classList.contains('revealed')) {
                        piece.style.backgroundImage = `url(${currentImage})`;
                        piece.style.backgroundPosition = `${-100 * (i % 3)}% ${-100 * Math.floor(i / 3)}%`;
                        piece.classList.add('revealed');
                        startCountdown();
                    }
                });
                if (puzzleDiv) puzzleDiv.appendChild(piece);
            }

            if (wordSetTitle) {
                wordSetTitle.innerHTML = `ชุดคำ : ${wordSets.find(set => set['ID ชุดคำ'] === word['ID ชุดคำ'])['ชื่อชุดคำ']} <br> (คำที่ ${currentWordIndex + 1} จากทั้งหมด ${currentWordSet.length} คำ)`;
            }

            if (nextWordButton) {
                if (currentWordIndex === currentWordSet.length - 1) {
                    nextWordButton.textContent = 'จบเกม';
                    nextWordButton.onclick = endGame;
                } else {
                    nextWordButton.textContent = 'คำถัดไป';
                    nextWordButton.onclick = () => {
                        currentWordIndex++;
                        nextWord();
                    };
                }
            }

            highlightActiveTeam();
        }

        function updateScore(team, change) {
            try {
                teamScores[team - 1] += change;
                const scoreElement = document.getElementById(`team${team}-score`);
                if (scoreElement) {
                    scoreElement.textContent = teamScores[team - 1];
                } else {
                    console.error(`Score element for team ${team} not found`);
                }
                highlightActiveTeam();
            } catch (error) {
                console.error('Error updating score:', error);
            }
        }


      async function startGame() {
    try {
        const team1NameInput = document.getElementById('team1-name-input');
        const team2NameInput = document.getElementById('team2-name-input');
        const team1IconSelect = document.getElementById('team1-icon-select');
        const team2IconSelect = document.getElementById('team2-icon-select');

        // สุ่ม icon ถ้าผู้เล่นไม่เลือก
        const team1Icon = team1IconSelect && team1IconSelect.value ? team1IconSelect.value : getRandomTeamIcon();
        const team2Icon = team2IconSelect && team2IconSelect.value ? team2IconSelect.value : getRandomTeamIcon();

        const team1Name = team1NameInput && team1NameInput.value ? team1NameInput.value : getTeamNameFromIcon(team1Icon);
        const team2Name = team2NameInput && team2NameInput.value ? team2NameInput.value : getTeamNameFromIcon(team2Icon);

        if (!wordSetSelect) {
            throw new Error('ไม่พบตัวเลือกชุดคำ กรุณารีเฟรชหน้าเว็บและลองใหม่อีกครั้ง');
        }

        const selectedWordSetId = wordSetSelect.value;
        if (!selectedWordSetId) {
            Swal.fire({
                icon: 'warning',
                title: 'กรุณาเลือกชุดคำ',
                text: 'โปรดเลือกชุดคำก่อนเริ่มเกม',
                confirmButtonText: 'ตกลง'
            });
            return;
        }

        currentWordSet = await fetchWords(selectedWordSetId);
        if (!currentWordSet || currentWordSet.length === 0) {
            throw new Error('ไม่พบคำในชุดคำที่เลือก');
        }

        // สุ่มลำดับของคำในชุดคำ
        currentWordSet = shuffleArray(currentWordSet);

        currentWordIndex = 0;
        teamScores = [0, 0];
        hintUsed = false;

        if (setupDiv) setupDiv.style.display = 'none';
        if (gameDiv) gameDiv.style.display = 'block';

        document.getElementById('team1-icon').textContent = team1Icon;
        document.getElementById('team1-name').textContent = team1Name;
        document.getElementById('team2-icon').textContent = team2Icon;
        document.getElementById('team2-name').textContent = team2Name;
        // แสดงปุ่มสร้าง PDF
        document.getElementById('generate-pdf-button').style.display = 'inline-block';
        document.getElementById('team1-score').textContent = '0';
        document.getElementById('team2-score').textContent = '0';

        currentOpeningTeam = Math.random() < 0.5 ? 1 : 2;
        
        highlightActiveTeam();

        Swal.fire({
            title: 'เริ่มเกม',
            html: `ทีม ${currentOpeningTeam} (${document.getElementById(`team${currentOpeningTeam}-name`).textContent}) เป็นฝ่ายเล่นก่อน`,
            icon: 'info',
            timer: 3000,
            timerProgressBar: true,
            showConfirmButton: false
        });

        createPuzzle();
    } catch (error) {
        console.error('Error starting game:', error);
        displayError(error.message || 'เกิดข้อผิดพลาดในการเริ่มเกม กรุณาลองใหม่อีกครั้ง');
    }
}

// เพิ่มฟังก์ชันสำหรับสุ่มลำดับของ array
function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

        function nextWord() {
            hintUsed = false;
            if (solutionModal) solutionModal.style.display = 'none';
            
            currentOpeningTeam = Math.random() < 0.5 ? 1 : 2;
            
            highlightActiveTeam();

            Swal.fire({
                title: 'ทีมถัดไป',
                html: `ทีม ${currentOpeningTeam} (${document.getElementById(`team${currentOpeningTeam}-name`).textContent}) เป็นฝ่ายเล่น`,
                icon: 'info',
                timer: 3000,
                timerProgressBar: true,
                showConfirmButton: false
            });

            createPuzzle();
        }

        function endGame() {
            const gameResult = getGameResult();
            Swal.fire({
                icon: 'info',
                title: 'จบเกม',
                html: gameResult.replace(/\n/g, '<br>'),
                confirmButtonText: 'เริ่มใหม่'
            }).then((result) => {
                if (result.isConfirmed) {
                    resetGame();
                }
            });
        }

        function resetGame() {
            resetPuzzle();
            if (solutionModal) solutionModal.style.display = 'none';
            if (setupDiv) setupDiv.style.display = 'block';
            if (gameDiv) gameDiv.style.display = 'none';
            currentWordIndex = 0;
            currentWordSet = [];
            teamScores = [0, 0];
             // ซ่อนปุ่มสร้าง PDF
            document.getElementById('generate-pdf-button').style.display = 'none';
        }

        function restartGame() {
            resetGame();
            Swal.fire({
                title: 'เริ่มเกมใหม่?',
                text: 'คุณต้องการเริ่มเกมใหม่ใช่หรือไม่? คะแนนทั้งหมดจะถูกรีเซ็ต',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'ใช่',
                cancelButtonText: 'ไม่'
            }).then((result) => {
                if (result.isConfirmed) {
                    setupDiv.style.display = 'block';
                    gameDiv.style.display = 'none';
                }
            });
        }

      function showHint() {
    if (currentWord && !hintUsed) {
        Swal.fire({
            title: 'คำใบ้',
            html: 'คุณสามารถใช้คำใบ้ได้เพียงครั้งเดียวต่อหนึ่งคำ<br>ทีมที่ใช้คำใบ้จะถูกหักคะแนน 1 แต้ม',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'ใช้คำใบ้',
            cancelButtonText: 'ยกเลิก'
        }).then((result) => {
            if (result.isConfirmed) {
                let thaiHint = currentWord.split('').map(char => 
                    char === currentRedLetter || Math.random() < 0.3 ? char : '_'
                ).join('');
                
                let englishHint = currentWordSet[currentWordIndex]['คำใบ้ภาษาอังกฤษ'] || 'No English hint available';

                Swal.fire({
                    title: 'คำใบ้',
                    html: `
                        <p>คำใบ้ภาษาไทย: ${thaiHint}</p>
                        <p>English Hint: ${englishHint}</p>
                        <button id="speak-hint" class="btn btn-primary">ฟังคำใบ้ภาษาอังกฤษ</button>
                    `,
                    icon: 'info',
                    confirmButtonText: 'ตกลง',
                    didOpen: () => {
                        document.getElementById('speak-hint').addEventListener('click', () => {
                            speakEnglishHint(englishHint);
                        });
                    }
                });
                hintUsed = true;
                updateScore(currentOpeningTeam, -1);
            }
        });
    }
}

function speakEnglishHint(text) {
    if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'en-US';
        utterance.rate = 0.8; // ปรับความเร็วการพูด (0.1 ถึง 10)
        speechSynthesis.speak(utterance);
    } else {
        console.log('Text-to-speech not supported.');
        alert('ขออภัย เบราว์เซอร์ของคุณไม่รองรับการอ่านออกเสียง');
    }
}

        function showSupportMessage() {
            Swal.fire({
                title: 'สนับสนุนเรา',
                html: `<img src="https://raw.githubusercontent.com/infobwd/STUDENT-CARE/main/ImageOnly.jpg" alt="Support" style="width: 100%; height: auto; margin-bottom: 10px;">
                       <p>ลดภาษีได้ 2 เท่าจากยอดสนับสนุน <br>ถ้า ❤️ ดีเลี้ยงกาแฟ นพรุจ ได้ที่ พร้อมเพย์ 
                       <span id="promptpay-number" onclick="showQRCode()">0836645989</span></p>`,
                confirmButtonText: 'ตกลง'
            });
        }

        function showQRCode() {
            Swal.close(); // Close the support modal

            Swal.fire({
                title: '❤️ ดีเลี้ยงกาแฟ นพรุจ',
                html: `<button onclick="generateQRCode(60)" class="btn btn-primary m-2 btn-qr-option">60 บาท</button>
                       <button onclick="generateQRCode(120)" class="btn btn-primary m-2 btn-qr-option">120 บาท</button>
                       <input type="number" id="custom-amount" class="form-control m-2 btn-qr-option" placeholder="จำนวนเงินอื่นๆ (บาท)">
                       <button onclick="generateQRCode(document.getElementById('custom-amount').value)" class="btn btn-primary m-2 btn-qr-option">กำหนดเอง</button>`,
                showCancelButton: false,
                showConfirmButton: false
            });
        }

        function generateQRCode(amount) {
            if (!amount || amount <= 0) {
                Swal.fire('กรุณาใส่จำนวนเงินที่ถูกต้อง');
                return;
            }
            const promptpayNumber = '0836645989';
            const qrCodeUrl = `https://promptpay.io/${promptpayNumber}/${amount}.png`;
            document.getElementById('qr-code-img').src = qrCodeUrl;
            document.getElementById('promptpay-number-display').textContent = `${promptpayNumber} (${amount} บาท)`;
            document.getElementById('qr-code-modal').style.display = 'flex';
            Swal.close();
        }

        function closeQRCodeModal() {
            document.getElementById('qr-code-modal').style.display = 'none';
        }

        function shareToFacebook() {
            html2canvas(document.querySelector("#puzzle")).then(canvas => {
                const imageData = canvas.toDataURL("image/png");
                const url = encodeURIComponent(window.location.href);
                const imageUrl = encodeURIComponent(imageData);
                window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}&quote=มาเล่นเกมเปิดป้ายทายคำกับเรา!&picture=${imageUrl}`, '_blank');
            });
        }



async function shareToLine() {
    if (!liff.isLoggedIn()) {
        try {
            await liff.login();
        } catch (error) {
            console.error('LIFF login failed', error);
            Swal.fire({
                title: 'เกิดข้อผิดพลาด',
                text: 'ไม่สามารถเข้าสู่ระบบ LINE ได้ กรุณาลองใหม่อีกครั้ง',
                icon: 'error',
                confirmButtonText: 'ตกลง'
            });
            return;
        }
    }

    let imageUrl, thaiHint, englishHint, wordSetName;

    if (currentWord && currentImage && currentWordSet && currentWordIndex !== undefined) {
        // ใช้คำที่กำลังเล่นอยู่
        imageUrl = currentImage;
        thaiHint = currentWord.split('').map(char => 
            char === currentRedLetter ? char : '_'
        ).join('');
        englishHint = currentWordSet[currentWordIndex]['คำใบ้ภาษาอังกฤษ'];
        const currentWordSetId = currentWordSet[currentWordIndex]['ID ชุดคำ'];
        wordSetName = wordSets.find(set => set['ID ชุดคำ'] === currentWordSetId)['ชื่อชุดคำ'];
    } else if (wordSets && wordSets.length > 0) {
        // กรณีที่ยังไม่ได้เริ่มเกม ให้สุ่มคำ
        const randomSetIndex = Math.floor(Math.random() * wordSets.length);
        const randomSet = wordSets[randomSetIndex];
        wordSetName = randomSet['ชื่อชุดคำ'];

        try {
            const wordsInSet = await fetchWords(randomSet['ID ชุดคำ']);
            
            if (wordsInSet && wordsInSet.length > 0) {
                const randomWordIndex = Math.floor(Math.random() * wordsInSet.length);
                const randomWord = wordsInSet[randomWordIndex];

                imageUrl = randomWord['ลิงก์รูปภาพ'];
                thaiHint = randomWord['คำ'].split('').map(char => 
                    char === randomWord['ตัวอักษรที่ต้องการให้สีต่างจากพวก'] ? char : '_'
                ).join('');
                englishHint = randomWord['คำใบ้ภาษาอังกฤษ'];
            } else {
                throw new Error('ไม่พบคำในชุดคำที่เลือก');
            }
        } catch (error) {
            console.error('Error processing words:', error);
            imageUrl = 'https://example.com/default-image.jpg';
            thaiHint = 'เริ่มเกมเพื่อดูคำใบ้';
            englishHint = 'Start the game to see the hint';
        }
    } else {
        imageUrl = 'https://example.com/default-image.jpg';
        thaiHint = 'เริ่มเกมเพื่อดูคำใบ้';
        englishHint = 'Start the game to see the hint';
        wordSetName = 'ไม่พบชุดคำ';
    }

    const flexMessage = {
        type: "flex",
        altText: "เชิญมาเล่นเกมเปิดป้ายทายคำ!",
        contents: {
            type: "bubble",
            size: "giga",
            hero: {
                type: "image",
                url: imageUrl,
                size: "full",
                aspectRatio: "20:13",
                aspectMode: "cover"
            },
            body: {
                type: "box",
                layout: "vertical",
                contents: [
                    {
                        type: "text",
                        text: "เกมเปิดป้ายทายคำ",
                        weight: "bold",
                        size: "xl"
                    },
                    {
                        type: "text",
                        text: `ชุดคำ: ${wordSetName}`,
                        margin: "md",
                        size: "sm",
                        color: "#aaaaaa"
                    },
                    {
                        type: "text",
                        text: `คำใบ้ภาษาไทย: ${thaiHint}`,
                        margin: "md"
                    },
                    {
                        type: "text",
                        text: `English Hint: ${englishHint}`,
                        margin: "sm",
                        wrap: true
                    }
                ]
            },
            footer: {
                type: "box",
                layout: "vertical",
                contents: [
                    {
                        type: "button",
                        style: "primary",
                        action: {
                            type: "uri",
                            label: "เล่นเกม",
                            uri: "https://liff.line.me/2005494853-90APVvvQ"
                        }
                    },
                    {
                        type: "text",
                        text: "@WDSchool",
                        align: "center",
                        margin: "md",
                        size: "xs",
                        color: "#aaaaaa"
                    }
                ]
            }
        }
    };

    try {
        const result = await liff.shareTargetPicker([flexMessage]);
        if (result) {
            Swal.fire({
                title: 'แชร์สำเร็จ!',
                text: 'ข้อความได้ถูกแชร์ไปยัง LINE แล้ว',
                icon: 'success',
                confirmButtonText: 'ตกลง'
            });
        } else {
            console.log('TargetPicker was closed before sharing.');
            Swal.fire({
                title: 'การแชร์ถูกยกเลิก',
                text: 'คุณได้ยกเลิกการแชร์',
                icon: 'info',
                confirmButtonText: 'ตกลง'
            });
        }
    } catch (error) {
        console.error('Error sharing message:', error);
        Swal.fire({
            title: 'เกิดข้อผิดพลาด',
            text: 'ไม่สามารถแชร์ข้อความได้ กรุณาลองใหม่อีกครั้ง',
            icon: 'error',
            confirmButtonText: 'ตกลง'
        });
    }
}

      
      
       function addEventListeners() {
    if (revealButton) revealButton.addEventListener('click', revealSolution);
    if (nextWordButton) nextWordButton.addEventListener('click', nextWord);
    if (startGameButton) startGameButton.addEventListener('click', startGame);
    if (restartGameButton) restartGameButton.addEventListener('click', restartGame);
    if (hintButton) hintButton.addEventListener('click', showHint);
    
    document.addEventListener('click', (event) => {
        if (event.target === solutionModal) {
            solutionModal.style.display = 'none';
        }
        if (event.target === countdownModal) {
            countdownModal.style.display = 'none';
            clearInterval(countdownInterval);
            const countdownAudio = document.getElementById('countdown-audio');
            if (countdownAudio) {
                countdownAudio.pause();
                countdownAudio.currentTime = 0;
            }
            switchTeam();
        }
    });
    
    if (shareButton) shareButton.addEventListener('click', shareToFacebook);
    if (lineButton) lineButton.addEventListener('click', shareToLine);

    const contactButton = document.getElementById('contactButton');
    if (contactButton) {
        const contactTooltip = new bootstrap.Tooltip(contactButton);
        contactButton.addEventListener('click', () => {
            Swal.fire({
                title: 'ติดต่อเรา',
                html: 'อีเมล: example@school.com<br>โทรศัพท์: 123-456-7890',
                icon: 'info',
                confirmButtonText: 'ปิด'
            });
        });

        contactButton.addEventListener('mouseenter', () => {
            contactTooltip.show();
            setTimeout(() => {
                contactTooltip.hide();
            }, 5000);
        });
    }

    const liffLoginButton = document.getElementById('liffLoginButton');
    const liffLogoutButton = document.getElementById('liffLogoutButton');
    
    if (liffLoginButton) {
        liffLoginButton.addEventListener('click', handleLogin);
    }
    if (liffLogoutButton) {
        liffLogoutButton.addEventListener('click', handleLogout);
    }

    const team1IconSelect = document.getElementById('team1-icon-select');
    const team2IconSelect = document.getElementById('team2-icon-select');
    const team1NameInput = document.getElementById('team1-name-input');
    const team2NameInput = document.getElementById('team2-name-input');

    if (team1IconSelect) {
        team1IconSelect.addEventListener('change', (e) => {
            if (!team1NameInput.value) {
                team1NameInput.value = getTeamNameFromIcon(e.target.value);
            }
        });
    }

    if (team2IconSelect) {
        team2IconSelect.addEventListener('change', (e) => {
            if (!team2NameInput.value) {
                team2NameInput.value = getTeamNameFromIcon(e.target.value);
            }
        });
    }
}

        function switchTeam() {
            currentOpeningTeam = currentOpeningTeam === 1 ? 2 : 1;
            highlightActiveTeam();
            Swal.fire({
                title: 'เปลี่ยนทีม',
                html: `ทีม ${currentOpeningTeam} (${document.getElementById(`team${currentOpeningTeam}-name`).textContent}) เป็นฝ่ายเล่น`,
                icon: 'info',
                timer: 3000,
                timerProgressBar: true,
                showConfirmButton: false
            });
        }

        const navbar = document.querySelector('.navbar');

        toggleNavbarButton.addEventListener('click', () => {
            if (navbar.style.display === 'none') {
                navbar.style.display = 'flex';
                toggleNavbarButton.style.display = 'none';
                showNavbarTab.style.display = 'none';
            } else {
                navbar.style.display = 'none';
                toggleNavbarButton.style.display = 'none';
                showNavbarTab.style.display = 'block';
            }
        });

        showNavbarTab.addEventListener('click', () => {
            navbar.style.display = 'flex';
            showNavbarTab.style.display = 'none';
            toggleNavbarButton.style.display = 'flex';
        });

        const fullscreenButton = document.getElementById('fullscreenButton');
        fullscreenButton.addEventListener('click', () => {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
                fullscreenButton.innerHTML = '<i class="bi bi-fullscreen-exit"></i>';
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                    fullscreenButton.innerHTML = '<i class="bi bi-fullscreen"></i>';
                }
            }
        });

        window.onclick = function(event) {
            const modal = document.getElementById('qr-code-modal');
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            try {
                addEventListeners();
                fetchWordSets().catch(error => {
                    console.error('Error during initial load:', error);
                    displayError('เกิดข้อผิดพลาดในการโหลดข้อมูลเริ่มต้น กรุณารีเฟรชหน้าเว็บ');
                });
                const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });
            } catch (error) {
                console.error('Error during initialization:', error);
            }
        });
      function initializeLiff() {
            liff.init({
                liffId: "2005494853-90APVvvQ"
            }).then(() => {
                if (liff.isLoggedIn()) {
                    updateUIForLoggedInUser();
                } else {
                    document.getElementById('liffLoginButton').style.display = 'block';
                }
            }).catch((err) => {
                console.error('LIFF Initialization failed', err);
            });
        }

function updateUIForLoggedInUser() {
  liff.getProfile().then((profile) => {
    document.getElementById('lineProfileImage').src = profile.pictureUrl;
    document.getElementById('lineProfileImage').style.display = 'block';
    document.getElementById('liffLoginButton').style.display = 'none';
    document.getElementById('liffLogoutButton').style.display = 'block';

    // Log user login
    logUserLogin(profile.userId, profile.displayName, profile.pictureUrl);

    // แสดง SweetAlert2 เมื่อ login สำเร็จ (ครั้งเดียว)
    if (!sessionStorage.getItem('welcomeMessageShown')) {
        Swal.fire({
          title: 'ยินดีต้อนรับ!',
          html: `<img src="${profile.pictureUrl}" alt="Line Profile" style="width: 100px; height: 100px; border-radius: 50%; margin-bottom: 15px;"><br>คุณ ${profile.displayName}`,
          icon: 'success',
          confirmButtonText: 'เริ่มเล่นเกม'
        });
        sessionStorage.setItem('welcomeMessageShown', 'true');
    }
  }).catch((err) => {
    console.error('Error getting profile', err);
  });
}

      function handleLogin() {
          if (!liff.isLoggedIn()) {
              liff.login().then(() => {
                  updateUIForLoggedInUser();
              }).catch((err) => {
                  console.error('Login failed', err);
              });
          }
      }

      function handleLogout() {
          if (liff.isLoggedIn()) {
              liff.logout();
              document.getElementById('lineProfileImage').style.display = 'none';
              document.getElementById('liffLoginButton').style.display = 'block';
              document.getElementById('liffLogoutButton').style.display = 'none';

              // แสดง SweetAlert2 เมื่อ logout สำเร็จ
              Swal.fire({
                  title: 'ออกจากระบบสำเร็จ',
                  text: 'แล้วกลับมาพาเด็ก ๆ เล่นใหม่นะครับ',
                  icon: 'info',
                  confirmButtonText: 'ตกลง'
              });

              // ลบ welcomeMessageShown จาก sessionStorage
              sessionStorage.removeItem('welcomeMessageShown');
          }
      }

      // เพิ่ม event listeners
      document.getElementById('liffLoginButton').addEventListener('click', handleLogin);
      document.getElementById('liffLogoutButton').addEventListener('click', handleLogout);

      // เรียกใช้ฟังก์ชัน initializeLiff เมื่อหน้าเว็บโหลดเสร็จ
      document.addEventListener('DOMContentLoaded', initializeLiff);  
      
    ///copy เลขพร้อมเพย์
      document.addEventListener('DOMContentLoaded', function() {
    const copyButton = document.getElementById('copy-promptpay');
    const copyFeedback = document.getElementById('copy-feedback');
    const promptpayNumber = "0836645989"; // กำหนดเลขพร้อมเพย์ที่ต้องการคัดลอกตรงนี้

    copyButton.addEventListener('click', function() {
        if (navigator.clipboard && window.isSecureContext) {
            // สำหรับ browser ที่รองรับ navigator.clipboard และเป็น secure context
            navigator.clipboard.writeText(promptpayNumber).then(() => {
                showCopyFeedback();
            });
        } else {
            // สำหรับ browser ที่ไม่รองรับ navigator.clipboard หรือไม่ใช่ secure context
            const textArea = document.createElement('textarea');
            textArea.value = promptpayNumber;
            textArea.style.position = 'fixed';  // ป้องกันการเลื่อนหน้าจอ
            textArea.style.left = '-9999px';  // ซ่อนนอกหน้าจอ
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                showCopyFeedback();
            } catch (err) {
                console.error('Unable to copy to clipboard', err);
                alert('ไม่สามารถคัดลอกได้ กรุณาคัดลอกด้วยตนเอง');
            }
            document.body.removeChild(textArea);
        }
    });

    function showCopyFeedback() {
        copyFeedback.style.display = 'block';
        setTimeout(() => {
            copyFeedback.style.display = 'none';
        }, 2000);
    }
});
      function logUserLogin(uid, profileName, profileImage) {
          const scriptUrl = 'https://script.google.com/macros/s/AKfycby78K_kXW1YhVKO4EQMUuXo8D78d2mQuT6fphBAsxmoL_T86WkhZdILmhHkgw-BD-ac/exec';

          fetch(scriptUrl, {
            method: 'POST',
            mode: 'no-cors',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              uid: uid,
              profileName: profileName,
              profileImage: profileImage
            })
          })
          .then(response => console.log('User login logged successfully'))
          .catch(error => console.error('Error logging user login:', error));
        }
 
    function generateHandwritingPDF() {
    if (!currentWordSet || currentWordSet.length === 0) {
        Swal.fire({
            title: 'ไม่พบคำ',
            text: 'กรุณาเริ่มเกมก่อนสร้างแบบฝึกคัดลายมือ',
            icon: 'warning',
            confirmButtonText: 'ตกลง'
        });
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    let yPosition = 20;
    let promises = [];

    currentWordSet.forEach((word, index) => {
        const tempDiv = document.createElement('div');
        tempDiv.style.position = 'absolute';
        tempDiv.style.left = '-9999px';
        tempDiv.style.fontFamily = "'Google Sans', sans-serif";
        tempDiv.style.fontSize = '32px'; // เพิ่มขนาดฟอนต์เพื่อความคมชัด
        tempDiv.style.fontWeight = '400';
        tempDiv.innerHTML = word['คำ']; // ลบเลขลำดับออก

        document.body.appendChild(tempDiv);

        promises.push(html2canvas(tempDiv, {
            scale: 2 // เพิ่มความละเอียดของ canvas
        }).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            doc.addImage(imgData, 'PNG', 20, yPosition - 15, canvas.width / 8, canvas.height / 8);
            
            yPosition += 10;

            for (let i = 0; i < 3; i++) {
                doc.setLineDash([2, 2]);
                doc.line(20, yPosition, 190, yPosition);
                yPosition += 10;
            }

            yPosition += 10;

            if (yPosition > 250) {
                doc.addPage();
                yPosition = 20;
            }

            document.body.removeChild(tempDiv);
        }));
    });

    Promise.all(promises).then(() => {
        doc.save('handwriting_practice.pdf');
    });
}
  
    </script>
</body>
</html>
